<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Vencimentos e Gastos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .modal {
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 90%;
            max-width: 500px;
        }
        .test-panel-active {
            background-color: #fef9c3 !important;
            border: 1px solid #facc15;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Controle de Vencimentos e Gastos</h1>
            <p class="text-slate-600 mt-2">Adicione produtos, suas quantidades, valores e dias para o vencimento.</p>
            <p id="currentTime" class="text-sm text-slate-500 mt-2 font-mono"></p>
        </header>

        <!-- Painel de Testes -->
        <div id="testPanel" class="bg-slate-200 p-4 rounded-xl shadow-inner mb-8 transition-colors duration-300">
             <h3 class="text-lg font-semibold mb-3 text-center text-slate-700">Painel de Testes</h3>
             <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                <label for="testDate" class="font-medium">Simular Data:</label>
                <input type="date" id="testDate" class="p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <button id="resetDate" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition">
                    <i class="fas fa-undo mr-2"></i>Resetar
                </button>
             </div>
             <p id="simulatedDateText" class="text-center text-sm text-blue-600 font-semibold mt-2 h-5"></p>
        </div>
        
        <!-- Adicionar Novo Produto -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-2xl font-semibold mb-4">Adicionar Novo Produto</h2>
            <form id="addItemForm" class="grid grid-cols-1 sm:grid-cols-6 gap-4 items-center">
                <input type="text" id="itemName" placeholder="Nome do produto" class="sm:col-span-6 md:col-span-3 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                <input type="number" id="itemQuantity" placeholder="Qtd." min="1" value="1" class="p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                <input type="number" id="itemValue" placeholder="Valor (R$)" min="0" step="0.01" class="p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                <input type="number" id="itemDays" placeholder="Dias para vencer" min="0" class="p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                <button type="submit" class="sm:col-span-6 w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition transform hover:scale-105">
                    Adicionar Item
                </button>
            </form>
        </div>

        <!-- Painéis de Gastos -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <!-- Previsão de Gastos -->
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-2xl font-semibold mb-4 text-center">Previsão de Gastos Futuros</h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                    <div>
                        <h3 id="forecastMonth1Name" class="text-lg font-bold text-slate-700">Mês Atual</h3>
                        <p id="forecastMonth1Value" class="text-2xl font-mono font-bold text-blue-600">R$ 0,00</p>
                    </div>
                    <div>
                        <h3 id="forecastMonth2Name" class="text-lg font-bold text-slate-700">Próximo Mês</h3>
                        <p id="forecastMonth2Value" class="text-2xl font-mono font-bold text-slate-800">R$ 0,00</p>
                    </div>
                    <div>
                        <h3 id="forecastMonth3Name" class="text-lg font-bold text-slate-700">Mês Seguinte</h3>
                        <p id="forecastMonth3Value" class="text-2xl font-mono font-bold text-slate-800">R$ 0,00</p>
                    </div>
                </div>
            </div>
             <!-- Gastos Realizados -->
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-2xl font-semibold mb-4 text-center">Gastos Realizados</h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                    <div>
                        <h3 id="realizedMonth1Name" class="text-lg font-bold text-slate-700">Mês Atual</h3>
                        <p id="realizedMonth1Value" class="text-2xl font-mono font-bold text-green-600">R$ 0,00</p>
                    </div>
                    <div>
                        <h3 id="realizedMonth2Name" class="text-lg font-bold text-slate-700">Mês Anterior</h3>
                        <p id="realizedMonth2Value" class="text-2xl font-mono font-bold text-slate-800">R$ 0,00</p>
                    </div>
                    <div>
                        <h3 id="realizedMonth3Name" class="text-lg font-bold text-slate-700">2 Meses Atrás</h3>
                        <p id="realizedMonth3Value" class="text-2xl font-mono font-bold text-slate-800">R$ 0,00</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Checklist de Vencimentos -->
            <div class="bg-white p-6 rounded-xl shadow-md">
                 <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-4">
                    <h2 class="text-2xl font-semibold">Checklist de Vencimentos</h2>
                    <div class="flex items-center gap-2">
                        <!-- Share Buttons -->
                        <button id="shareWhatsappButton" title="Compartilhar no WhatsApp" class="bg-green-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-green-600 transition transform hover:scale-105">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                        <button id="copyChecklistButton" title="Copiar para Área de Transferência" class="bg-slate-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-slate-600 transition transform hover:scale-105">
                            <i class="fas fa-copy"></i>
                        </button>
                        <span class="border-l border-slate-300 h-8 mx-2"></span>
                        <label for="checklistDays" class="font-medium text-slate-700 text-sm">Mostrar em (dias):</label>
                        <input type="number" id="checklistDays" value="7" min="1" class="p-2 w-20 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-center">
                    </div>
                </div>
                <p id="emptyMessage" class="text-slate-500">Nenhum item vencendo no período.</p>
                <div id="checklist" class="space-y-3"></div>
            </div>
            
            <!-- Todos os Itens Cadastrados -->
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-4">
                    <h2 class="text-2xl font-semibold">Todos os Itens Cadastrados</h2>
                    <div class="relative w-full sm:w-auto">
                        <input type="text" id="masterListSearch" placeholder="Pesquisar itens..." class="w-full p-2 pl-10 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-slate-400"></i>
                        </div>
                    </div>
                </div>
                <p id="emptyMasterMessage" class="text-slate-500 hidden">Nenhum item cadastrado ainda.</p>
                <div id="masterList" class="space-y-3"></div>
            </div>
        </div>
        
        <!-- Import/Export -->
        <div class="bg-white p-6 rounded-xl shadow-md mt-8">
            <h2 class="text-2xl font-semibold mb-4">Gerenciamento de Dados</h2>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="exportData" class="bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition transform hover:scale-105">
                    <i class="fas fa-download mr-2"></i>Exportar Dados (JSON)
                </button>
                <input type="file" id="importFile" accept=".json" class="hidden" />
                <button id="importData" class="bg-purple-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition transform hover:scale-105">
                    <i class="fas fa-upload mr-2"></i>Importar Dados (JSON)
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Item -->
    <div id="editItemModal" class="modal hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-semibold mb-4">Editar Produto</h2>
            <form id="editItemForm" class="grid grid-cols-1 gap-4">
                <input type="hidden" id="editItemId">
                <div>
                    <label for="editItemName" class="block text-sm font-medium text-slate-700">Nome</label>
                    <input type="text" id="editItemName" class="w-full p-3 border border-slate-300 rounded-lg" required>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                         <label for="editItemQuantity" class="block text-sm font-medium text-slate-700">Quantidade</label>
                        <input type="number" id="editItemQuantity" min="1" class="w-full p-3 border border-slate-300 rounded-lg" required>
                    </div>
                    <div>
                         <label for="editItemValue" class="block text-sm font-medium text-slate-700">Valor (R$)</label>
                        <input type="number" id="editItemValue" min="0" step="0.01" class="w-full p-3 border border-slate-300 rounded-lg" required>
                    </div>
                     <div>
                        <label for="editItemDays" class="block text-sm font-medium text-slate-700">Dias para Vencer</label>
                        <input type="number" id="editItemDays" min="0" class="w-full p-3 border border-slate-300 rounded-lg" required>
                    </div>
                </div>
                 <div class="flex justify-end gap-4 mt-2">
                     <button type="button" id="closeModalButton" class="bg-gray-300 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700">
                        Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>

     <!-- Modal Alerta/Confirmação -->
    <div id="customAlertModal" class="modal hidden">
        <div class="modal-content text-center">
            <h3 id="alertTitle" class="text-xl font-bold mb-4">Aviso</h3>
            <p id="alertMessage" class="mb-6"></p>
            <div id="alertButtons" class="flex justify-center gap-4"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÃO DO BANCO DE DADOS (INDEXEDDB) ---
        let db;
        const dbVersion = 3;
        const dbName = `vencimentosDB_v${dbVersion}`;
        const productsStoreName = 'produtos';
        const historyStoreName = 'historicoCompras'; // Novo store

        // --- ESTADO DA APLICAÇÃO ---
        let simulatedDate = null;
        let checklistDisplayDays = parseInt(localStorage.getItem('checklistDays')) || 7; 
        
        const request = indexedDB.open(dbName, dbVersion);

        request.onerror = (event) => console.error("Erro no IndexedDB:", event.target.error);

        request.onupgradeneeded = (event) => {
            db = event.target.result;
            if (!db.objectStoreNames.contains(productsStoreName)) {
                db.createObjectStore(productsStoreName, { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains(historyStoreName)) {
                db.createObjectStore(historyStoreName, { keyPath: 'id', autoIncrement: true });
            }
        };

        request.onsuccess = (event) => {
            db = event.target.result;
            initialize();
        };

        function initialize() {
            setupTestControls();
            setupChecklistSettings();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            renderAllData();
            setupMasterListSearch(); // Inicializa a função de busca
        }
        
        // --- FUNÇÕES DE DATA E HORA ---
        function getSystemDate() {
            if (simulatedDate) {
                const date = new Date(simulatedDate);
                const userTimezoneOffset = date.getTimezoneOffset() * 60000;
                return new Date(date.getTime() + userTimezoneOffset);
            }
            return new Date();
        }

        function getDayWithoutTime(dateInput) {
            const date = new Date(dateInput);
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            const correctedDate = new Date(date.getTime() + userTimezoneOffset);
            correctedDate.setHours(0, 0, 0, 0);
            return correctedDate;
        }
        
        function formatDateToYMD(date) {
            return date.toISOString().slice(0, 10);
        }

        function updateCurrentTime() {
            document.getElementById('currentTime').textContent = `Data e Hora Atuais: ${new Date().toLocaleString('pt-BR')}`;
        }
        
        // --- FUNÇÕES DE RENDERIZAÇÃO ---
        function renderAllData() {
            if (!db) return;
            
            const transaction = db.transaction([productsStoreName, historyStoreName], 'readonly');
            const productsStore = transaction.objectStore(productsStoreName);
            const historyStore = transaction.objectStore(historyStoreName);

            const getAllProductsRequest = productsStore.getAll();
            const getAllHistoryRequest = historyStore.getAll();

            getAllProductsRequest.onerror = (event) => console.error("Erro ao buscar produtos:", event.target.error);
            getAllHistoryRequest.onerror = (event) => console.error("Erro ao buscar histórico:", event.target.error);

            getAllProductsRequest.onsuccess = () => {
                const allItems = getAllProductsRequest.result;
                renderChecklist(allItems);
                renderAllItemsList(allItems); // A função renderAllItemsList agora lida com o filtro
                renderForecast(allItems);
            };

            getAllHistoryRequest.onsuccess = () => {
                const allHistory = getAllHistoryRequest.result;
                renderRealizedExpenses(allHistory);
            };
        }

        function renderChecklist(allItems) {
            const checklistDiv = document.getElementById('checklist');
            const emptyMessage = document.getElementById('emptyMessage');
            checklistDiv.innerHTML = ''; 

            const today = getDayWithoutTime(getSystemDate());
            const daysToConsider = checklistDisplayDays;
            const daysFromNow = new Date(today);
            daysFromNow.setDate(today.getDate() + daysToConsider);

            const itemsToDisplay = allItems.filter(item => {
                const dueDate = getDayWithoutTime(item.dueDate);
                return dueDate <= daysFromNow;
            });
            
            itemsToDisplay.sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));

            if (itemsToDisplay.length > 0) {
                emptyMessage.classList.add('hidden');
                itemsToDisplay.forEach(item => createItemElement(item, checklistDiv, true));
            } else {
                emptyMessage.classList.remove('hidden');
                emptyMessage.textContent = `Nenhum item vencendo nos próximos ${checklistDisplayDays} dia(s).`;
            }
        }
        
        function renderAllItemsList(allItems) {
            const masterListDiv = document.getElementById('masterList');
            const emptyMasterMessage = document.getElementById('emptyMasterMessage');
            masterListDiv.innerHTML = '';

            const searchTerm = document.getElementById('masterListSearch').value.toLowerCase();

            // Modificação: Filtrar por iniciais usando startsWith()
            const filteredItems = allItems.filter(item => {
                return item.name.toLowerCase().startsWith(searchTerm);
            });

            filteredItems.sort((a, b) => a.name.localeCompare(b.name, 'pt-BR'));

            if (filteredItems.length > 0) {
                emptyMasterMessage.classList.add('hidden');
                filteredItems.forEach(item => createItemElement(item, masterListDiv, false));
            } else {
                emptyMasterMessage.classList.remove('hidden');
                emptyMasterMessage.textContent = searchTerm ? `Nenhum item encontrado para "${searchTerm}".` : `Nenhum item cadastrado ainda.`;
            }
        }
        
        function createItemElement(item, parentDiv, showBuyButton) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'fade-in flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 bg-slate-100 rounded-lg gap-3';
            
            const dueDate = getDayWithoutTime(item.dueDate);
            const today = getDayWithoutTime(getSystemDate());
            const timeDiff = dueDate.getTime() - today.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            let dateText = `Vence em ${daysDiff} dias`;
            let textColor = 'text-slate-600';
            
            if (daysDiff === 1) { dateText = `Vence amanhã`; textColor = 'text-yellow-600 font-semibold'; }
            else if (daysDiff === 0) { dateText = `Vence hoje`; textColor = 'text-red-600 font-bold'; }
            else if (daysDiff < 0) { dateText = `Vencido há ${Math.abs(daysDiff)} dia(s)`; textColor = 'text-red-700 font-bold'; }
            
            const formattedDueDate = new Date(item.dueDate + 'T00:00:00').toLocaleDateString('pt-BR');
            const formattedValue = (item.valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const totalValue = ((item.valor || 0) * (item.quantidade || 1)).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            itemDiv.innerHTML = `
                <div class="flex-grow">
                    <p class="font-semibold text-lg">${item.name}</p>
                    <p class="text-sm ${textColor}">${dateText} (em ${formattedDueDate})</p>
                    <p class="text-sm text-slate-500">
                        Qtd: ${item.quantidade || 1} | Val. Unit.: ${formattedValue} | Total: <span class="font-bold">${totalValue}</span>
                    </p>
                </div>
                <div class="flex gap-2 self-end sm:self-center">
                    ${showBuyButton ? `
                        <button data-id="${item.id}" title="Comprar" class="buy-button bg-blue-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-blue-700 transform hover:scale-105 transition"><i class="fas fa-shopping-cart"></i></button>
                        <button data-id="${item.id}" title="Remover da Checklist" class="remove-from-checklist-button bg-red-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-red-700"><i class="fas fa-trash-alt"></i></button>
                        <button data-id="${item.id}" title="Editar" class="edit-button bg-yellow-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-yellow-600"><i class="fas fa-pencil-alt"></i></button>
                    ` : `
                        <button data-id="${item.id}" title="Mover para Checklist" class="move-to-checklist-button bg-green-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-green-600"><i class="fas fa-list-check"></i></button>
                        <button data-id="${item.id}" title="Editar" class="edit-button bg-yellow-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-yellow-600"><i class="fas fa-pencil-alt"></i></button>
                        <button data-id="${item.id}" title="Deletar" class="delete-button bg-red-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-red-700"><i class="fas fa-trash-alt"></i></button>
                    `}
                </div>
            `;
            parentDiv.appendChild(itemDiv);
        }

        function renderForecast(allItems) {
            const today = getSystemDate();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

            const forecastMonths = [
                { year: currentYear, month: currentMonth, total: 0 },
                { year: currentMonth === 11 ? currentYear + 1 : currentYear, month: (currentMonth + 1) % 12, total: 0 },
                { year: currentMonth >= 10 ? currentYear + 1 : currentYear, month: (currentMonth + 2) % 12, total: 0 },
            ];

            allItems.forEach(item => {
                const dueDate = new Date(item.dueDate + 'T00:00:00');
                const itemMonth = dueDate.getMonth();
                const itemYear = dueDate.getFullYear();
                const itemValue = (item.valor || 0) * (item.quantidade || 1);

                for (const forecast of forecastMonths) {
                    if (itemYear === forecast.year && itemMonth === forecast.month) {
                        forecast.total += itemValue;
                    }
                }
            });
            
            for (let i = 0; i < 3; i++) {
                document.getElementById(`forecastMonth${i+1}Name`).textContent = monthNames[forecastMonths[i].month];
                document.getElementById(`forecastMonth${i+1}Value`).textContent = forecastMonths[i].total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }
        }

        function renderRealizedExpenses(allHistory) {
            const today = getSystemDate();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            
            // Mês atual, mês anterior, 2 meses atrás
            const realizedMonths = [
                { year: currentYear, month: currentMonth, total: 0 },
                { year: currentMonth === 0 ? currentYear - 1 : currentYear, month: (currentMonth - 1 + 12) % 12, total: 0 },
                { year: currentMonth <= 1 ? currentYear - 1 : currentYear, month: (currentMonth - 2 + 12) % 12, total: 0 },
            ];

            allHistory.forEach(purchase => {
                const purchaseDate = new Date(purchase.purchaseDate + 'T00:00:00');
                const purchaseMonth = purchaseDate.getMonth();
                const purchaseYear = purchaseDate.getFullYear();
                
                for (const realized of realizedMonths) {
                    if (purchaseYear === realized.year && purchaseMonth === realized.month) {
                        realized.total += purchase.totalValue;
                    }
                }
            });
            
            for (let i = 0; i < 3; i++) {
                const nameEl = document.getElementById(`realizedMonth${i+1}Name`);
                const valueEl = document.getElementById(`realizedMonth${i+1}Value`);
                
                nameEl.textContent = i === 0 ? "Mês Atual" : (i === 1 ? "Mês Anterior" : monthNames[realizedMonths[i].month]);
                valueEl.textContent = realizedMonths[i].total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }
        }

        // --- FUNÇÕES DE MANIPULAÇÃO DE DADOS ---
        function addItem(event) {
            event.preventDefault();
            const name = document.getElementById('itemName').value.trim();
            const quantity = parseInt(document.getElementById('itemQuantity').value);
            const value = parseFloat(document.getElementById('itemValue').value);
            const days = parseInt(document.getElementById('itemDays').value);

            if (!name || isNaN(quantity) || isNaN(value) || isNaN(days) || days < 0 || quantity < 1 || value < 0) {
                showAlert('Por favor, preencha todos os campos com valores válidos.');
                return;
            }

            const today = getSystemDate();
            today.setDate(today.getDate() + days);
            
            const newItem = { 
                name: name, 
                quantidade: quantity,
                valor: value,
                dueDate: formatDateToYMD(today),
                originalDays: days // Armazena os dias originais
            };

            const transaction = db.transaction(productsStoreName, 'readwrite');
            const store = transaction.objectStore(productsStoreName);
            store.add(newItem).onsuccess = () => {
                document.getElementById('addItemForm').reset();
                document.getElementById('itemQuantity').value = 1; 
                renderAllData();
            };
        }
        
        function deleteItem(itemId) {
            showConfirm('Tem certeza que deseja deletar este item permanentemente do cadastro?', () => {
                const transaction = db.transaction(productsStoreName, 'readwrite');
                transaction.objectStore(productsStoreName).delete(itemId);
                transaction.oncomplete = () => renderAllData();
            });
        }

        // Nova função para remover o item apenas da checklist
        function removeItemFromChecklistDisplay(itemId) {
            showConfirm('Tem certeza que deseja remover este item da checklist? Ele permanecerá no cadastro geral.', () => {
                const transaction = db.transaction(productsStoreName, 'readwrite');
                const productsStore = transaction.objectStore(productsStoreName);
                const getRequest = productsStore.get(itemId);

                getRequest.onsuccess = () => {
                    const item = getRequest.result;
                    if (!item) return;

                    // Recalcula a data de vencimento com base nos dias originais a partir da data atual
                    const newDueDate = getSystemDate();
                    newDueDate.setDate(newDueDate.getDate() + (item.originalDays || 0)); // Usa originalDays ou 0 se não existir
                    
                    item.dueDate = formatDateToYMD(newDueDate); 
                    productsStore.put(item).onsuccess = () => {
                        showAlert(`"${item.name}" removido da checklist e data de vencimento restaurada.`);
                        renderAllData();
                    };
                };
            });
        }

        function buyItem(itemId) {
            const transaction = db.transaction([productsStoreName, historyStoreName], 'readwrite');
            const productsStore = transaction.objectStore(productsStoreName);
            const historyStore = transaction.objectStore(historyStoreName);
            const getRequest = productsStore.get(itemId);

            getRequest.onsuccess = () => {
                const item = getRequest.result;
                if (!item) return;

                const purchaseRecord = {
                    name: item.name,
                    totalValue: (item.valor || 0) * (item.quantidade || 1),
                    purchaseDate: formatDateToYMD(getSystemDate())
                };

                historyStore.add(purchaseRecord);
                
                // Atualiza a data de vencimento do item para ser recontada a partir da compra
                const newDueDate = getSystemDate();
                newDueDate.setDate(newDueDate.getDate() + item.originalDays);
                
                item.dueDate = formatDateToYMD(newDueDate);
                productsStore.put(item); 
                
                transaction.oncomplete = () => {
                    showAlert(`"${item.name}" comprado e data de vencimento atualizada para ${newDueDate.toLocaleDateString('pt-BR')}.`);
                    renderAllData();
                };
            };
        }

        // Função modificada para Mover para Checklist
        function moveToChecklist(itemId) {
            const transaction = db.transaction(productsStoreName, 'readwrite');
            const productsStore = transaction.objectStore(productsStoreName);
            const getRequest = productsStore.get(itemId);

            getRequest.onsuccess = () => {
                const item = getRequest.result;
                if (!item) return;

                // Atualiza a data de vencimento do item existente para o dia atual
                // Isso fará com que ele apareça na checklist sem criar uma duplicata.
                item.dueDate = formatDateToYMD(getSystemDate()); 
                
                productsStore.put(item).onsuccess = () => {
                    showAlert(`"${item.name}" teve a data de vencimento atualizada para hoje e aparecerá na checklist.`);
                    renderAllData();
                };
            };
        }

        function openEditModal(itemId) {
            const transaction = db.transaction(productsStoreName, 'readonly');
            transaction.objectStore(productsStoreName).get(itemId).onsuccess = (event) => {
                const item = event.target.result;
                if (!item) return;

                const dueDate = getDayWithoutTime(item.dueDate);
                const today = getDayWithoutTime(getSystemDate());
                const timeDiff = dueDate.getTime() - today.getTime();
                const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));

                document.getElementById('editItemId').value = item.id;
                document.getElementById('editItemName').value = item.name;
                document.getElementById('editItemQuantity').value = item.quantidade || 1;
                document.getElementById('editItemValue').value = item.valor || 0;
                // Ao abrir o modal de edição, exibe os dias originais se disponíveis, senão calcula a diferença
                document.getElementById('editItemDays').value = item.originalDays !== undefined ? item.originalDays : Math.max(0, daysDiff);
                document.getElementById('editItemModal').classList.remove('hidden');
            };
        }

        function closeEditModal() {
            document.getElementById('editItemModal').classList.add('hidden');
        }

        function saveEditedItem(event) {
            event.preventDefault();
            const itemId = parseInt(document.getElementById('editItemId').value);
            const name = document.getElementById('editItemName').value.trim();
            const quantity = parseInt(document.getElementById('editItemQuantity').value);
            const value = parseFloat(document.getElementById('editItemValue').value);
            const days = parseInt(document.getElementById('editItemDays').value);

            if (!name || isNaN(quantity) || isNaN(value) || isNaN(days) || days < 0) {
                showAlert('Por favor, preencha todos os campos com valores válidos.');
                return;
            }

            const transaction = db.transaction(productsStoreName, 'readwrite');
            const store = transaction.objectStore(productsStoreName);
            const getRequest = store.get(itemId);

            getRequest.onsuccess = () => {
                const item = getRequest.result;
                if (!item) return;

                const newDueDate = getSystemDate();
                newDueDate.setDate(newDueDate.getDate() + days);

                item.name = name;
                item.quantidade = quantity;
                item.valor = value;
                item.dueDate = formatDateToYMD(newDueDate);
                item.originalDays = days; // Atualiza originalDays ao salvar
                
                store.put(item).onsuccess = () => {
                    closeEditModal();
                    renderAllData();
                };
            };
        }
        
        // --- FUNÇÕES DE COMPARTILHAMENTO E CÓPIA ---
        function getChecklistAsText() {
            const checklistDiv = document.getElementById('checklist');
            const items = checklistDiv.querySelectorAll('.fade-in');
            const today = getSystemDate();
            
            if (items.length === 0) {
                return "Nenhum item na lista de checklist no momento.";
            }

            let checklistText = `*Checklist de Compras - ${today.toLocaleDateString('pt-BR')}*\n\n`;

            items.forEach(itemDiv => {
                const name = itemDiv.querySelector('.font-semibold').textContent;
                const details = itemDiv.querySelector('.text-sm.text-slate-500').textContent.trim();
                const dueDateText = itemDiv.querySelector('p:nth-child(2)').textContent;
                
                const qtdMatch = details.match(/Qtd: ([\d,]+)/);
                const quantity = qtdMatch ? qtdMatch[1] : 'N/A';

                checklistText += `• ${name} (Qtd: ${quantity}) - ${dueDateText}\n`;
            });

            return checklistText;
        }

        function shareOnWhatsApp() {
            const text = getChecklistAsText();
            if (!text) return;
            const encodedText = encodeURIComponent(text);
            const url = `https://wa.me/?text=${encodedText}`;
            window.open(url, '_blank');
        }

        function copyToClipboard() {
            const textToCopy = getChecklistAsText();
            if (!textToCopy) return;

            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            textArea.style.position = "fixed";
            textArea.style.top = "-9999px";
            textArea.style.left = "-9999px";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                // Usando document.execCommand para maior compatibilidade, especialmente em iframes
                document.execCommand('copy');
                showAlert('Lista copiada para a área de transferência!');
            } catch (err) {
                showAlert('Ocorreu um erro ao tentar copiar a lista.');
                console.error('Erro ao copiar:', err);
            }

            document.body.removeChild(textArea);
        }

        // --- IMPORT/EXPORT ---
        function exportData() {
            if (!db) { showAlert("Banco de dados não disponível."); return; }
            const transaction = db.transaction([productsStoreName, historyStoreName], 'readonly');
            const productsRequest = transaction.objectStore(productsStoreName).getAll();
            const historyRequest = transaction.objectStore(historyStoreName).getAll();
            const exportObject = {};

            transaction.oncomplete = () => {
                exportObject.products = productsRequest.result;
                exportObject.history = historyRequest.result;
                
                const data = JSON.stringify(exportObject, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'controle_de_gastos_data.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showAlert("Dados exportados com sucesso!");
            };
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!importedData.products || !Array.isArray(importedData.products)) {
                         throw new Error("Formato de JSON inválido. 'products' não encontrado ou não é uma lista.");
                    }
                    // O histórico é opcional para compatibilidade com arquivos antigos
                    const historyToImport = (importedData.history && Array.isArray(importedData.history)) ? importedData.history : [];

                    showConfirm('Importar dados substituirá TODOS os itens e histórico existentes. Deseja continuar?', () => {
                        const transaction = db.transaction([productsStoreName, historyStoreName], 'readwrite');
                        const productsStore = transaction.objectStore(productsStoreName);
                        const historyStore = transaction.objectStore(historyStoreName);

                        productsStore.clear();
                        historyStore.clear();

                        importedData.products.forEach(item => {
                            // Garante que 'originalDays' seja importado ou definido
                            if (item.originalDays === undefined && item.dueDate) {
                                // Se originalDays não existe, tenta calcular a partir da dueDate e da data atual
                                const itemDueDate = getDayWithoutTime(item.dueDate);
                                const today = getDayWithoutTime(getSystemDate());
                                const timeDiff = itemDueDate.getTime() - today.getTime();
                                item.originalDays = Math.ceil(timeDiff / (1000 * 3600 * 24));
                            } else if (item.originalDays === undefined) {
                                item.originalDays = 0; // Valor padrão se não houver dueDate
                            }
                            delete item.id;
                            productsStore.add(item);
                        });
                        historyToImport.forEach(record => {
                            delete record.id;
                            historyStore.add(record);
                        });

                        transaction.oncomplete = () => {
                            showAlert("Dados importados com sucesso!");
                            renderAllData();
                        };
                    });
                } catch (err) {
                    showAlert("Erro ao ler o arquivo JSON. Verifique se o formato está correto.");
                    console.error("Erro no parse do JSON:", err);
                }
            };
            reader.readAsText(file);
            event.target.value = null; // Reseta o input para permitir re-importar o mesmo arquivo
        }

        // --- CONTROLES DE TESTE E CONFIGURAÇÕES ---
        function setupTestControls() {
            const testDateInput = document.getElementById('testDate');
            const resetDateButton = document.getElementById('resetDate');
            const testPanel = document.getElementById('testPanel');
            const simulatedDateText = document.getElementById('simulatedDateText');
            
            testDateInput.addEventListener('change', () => {
                simulatedDate = testDateInput.value;
                const displayDate = new Date(simulatedDate + 'T00:00:00').toLocaleDateString('pt-BR');
                simulatedDateText.textContent = `Simulando data: ${displayDate}`;
                testPanel.classList.add('test-panel-active');
                renderAllData();
            });

            resetDateButton.addEventListener('click', () => {
                simulatedDate = null;
                testDateInput.value = '';
                simulatedDateText.textContent = '';
                testPanel.classList.remove('test-panel-active');
                renderAllData();
            });
        }

        function setupChecklistSettings() {
            const checklistDaysInput = document.getElementById('checklistDays');
            checklistDaysInput.value = checklistDisplayDays; 
            checklistDaysInput.addEventListener('change', () => {
                let newDays = parseInt(checklistDaysInput.value) || 1;
                checklistDisplayDays = newDays;
                localStorage.setItem('checklistDays', newDays);
                renderAllData();
            });
        }

        // --- FUNÇÕES DE BUSCA ---
        function setupMasterListSearch() {
            const masterListSearchInput = document.getElementById('masterListSearch');
            masterListSearchInput.addEventListener('keyup', () => {
                // Re-renderiza a lista mestre sempre que o usuário digita no campo de busca
                // A função renderAllItemsList já inclui a lógica de filtro.
                renderAllData(); 
            });
        }

        // --- MODAIS CUSTOMIZADOS ---
        function showAlert(message) {
            const modal = document.getElementById('customAlertModal');
            document.getElementById('alertTitle').innerText = 'Aviso';
            document.getElementById('alertMessage').innerText = message;
            document.getElementById('alertButtons').innerHTML = `<button class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700" onclick="document.getElementById('customAlertModal').classList.add('hidden')">OK</button>`;
            modal.classList.remove('hidden');
        }

        function showConfirm(message, onConfirm) {
            const modal = document.getElementById('customAlertModal');
            document.getElementById('alertTitle').innerText = 'Confirmação';
            document.getElementById('alertMessage').innerText = message;
            document.getElementById('alertButtons').innerHTML = `
                <button id="cancelButton" class="bg-gray-300 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirmButton" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700">Confirmar</button>
            `;
            modal.classList.remove('hidden');
            document.getElementById('cancelButton').onclick = () => modal.classList.add('hidden');
            document.getElementById('confirmButton').onclick = () => {
                modal.classList.add('hidden');
                onConfirm();
            };
        }

        // --- EVENT LISTENERS GLOBAIS ---
        document.getElementById('addItemForm').addEventListener('submit', addItem);
        document.querySelector('.container').addEventListener('click', (event) => {
            const button = event.target.closest('button');
            if (!button || !button.dataset.id) return;
            const itemId = parseInt(button.dataset.id);
            
            if (button.classList.contains('delete-button')) deleteItem(itemId); // Para exclusão permanente do cadastro
            if (button.classList.contains('remove-from-checklist-button')) removeItemFromChecklistDisplay(itemId); // Para remoção apenas da checklist
            if (button.classList.contains('edit-button')) openEditModal(itemId);
            if (button.classList.contains('buy-button')) buyItem(itemId);
            if (button.classList.contains('move-to-checklist-button')) moveToChecklist(itemId);
        });
        document.getElementById('closeModalButton').addEventListener('click', closeEditModal);
        document.getElementById('editItemForm').addEventListener('submit', saveEditedItem);
        document.getElementById('editItemModal').addEventListener('click', (event) => {
            if (event.target.id === 'editItemModal') closeEditModal();
        });
        document.getElementById('exportData').addEventListener('click', exportData);
        document.getElementById('importData').addEventListener('click', () => document.getElementById('importFile').click());
        document.getElementById('importFile').addEventListener('change', importData);
        document.getElementById('shareWhatsappButton').addEventListener('click', shareOnWhatsApp);
        document.getElementById('copyChecklistButton').addEventListener('click', copyToClipboard);

    </script>
</body>
</html>
